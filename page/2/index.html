<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>🐏&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="🐏&#039;s Blog"><meta name="msapplication-TileImage" content="/img/logo.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="🐏&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="🐏&#039;s Blog"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="🐏&#039;s Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="Yang"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"🐏's Blog","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"Yang"},"publisher":{"@type":"Organization","name":"🐏's Blog","logo":{"@type":"ImageObject","url":"http://example.com/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/logo.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 6.0.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="🐏&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Yang-Emily/Yang-Emily.github.io"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-06-12T06:43:54.000Z" title="2022/6/12 下午2:43:54">2022-06-12</time>发表</span><span class="level-item"><time dateTime="2022-06-20T15:48:44.961Z" title="2022/6/20 下午11:48:44">2022-06-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a></span><span class="level-item">几秒读完 (大约0个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/12/%E5%A4%8D%E4%B9%A0%20bert/">Review - Bert</a></h1><div class="content"></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-06-12T06:43:54.000Z" title="2022/6/12 下午2:43:54">2022-06-12</time>发表</span><span class="level-item"><time dateTime="2022-06-20T15:54:01.742Z" title="2022/6/20 下午11:54:01">2022-06-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a></span><span class="level-item">11 分钟读完 (大约1598个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/12/%E5%A4%8D%E4%B9%A0%20transformer/">Review - Transformer</a></h1><div class="content"><p>回顾《 attention is all your need 》，transformer 的结构如下图所示，Inputs 包括 embedding 和 positional encodeing，将词嵌入结合位置信息；Encoder 包括 N 个堆叠的层，每个层中的多头注意力机制和前馈神经网络后都进行了残差和归一化连接；Decoder 包括 N 个堆叠的层，与 Encoder 不同的是，它还多了一层 masked multi-head attention；Output 包括简单的线性层和 softmax 。</p>
<p><img src="https://uploadfiles.nowcoder.com/images/20220620/799168342_1655707530470/CC13B77D33AB41DCE75324F9024F53C5" alt="模型整体结构图"></p>
<h2 id="Inputs"><a href="#Inputs" class="headerlink" title="Inputs"></a>Inputs</h2><p>embedding 将文本处理为向量，如word embedding。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Embeddings</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, d_model, vocab</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Embeddings, self).__init__()</span><br><span class="line">        self.lut = nn.Embedding(vocab, d_model)</span><br><span class="line">        self.d_model = d_model</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        embedds = self.lut(x)</span><br><span class="line">        <span class="keyword">return</span> embedds * math.sqrt(self.d_model)</span><br><span class="line">        <span class="comment"># 这里在给词向量添加位置编码之前，扩大词向量的数值目的是让位置编码相对较小。</span></span><br><span class="line">        <span class="comment"># 这意味着向词向量添加位置编码时，词向量的原始含义不会丢失。</span></span><br></pre></td></tr></table></figure>

<p>positional ecoding 添加位置信息，采用正余弦可以避免句子长短不一时对位置带来的影响。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PositionalEncoding</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, d_model, dropout, max_len=<span class="number">5000</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(PositionalEncoding, self).__init__()</span><br><span class="line">        self.dropout = nn.Dropout(p=dropout)</span><br><span class="line">        <span class="comment"># 为防止当1000的幂作为分母导致的float溢出，对公式进行转换</span></span><br><span class="line">        pe = torch.zeros(max_len, d_model)</span><br><span class="line">        position = torch.arange(<span class="number">0</span>, max_len).unsqueeze(<span class="number">1</span>)</span><br><span class="line">        div_term = torch.exp(torch.arange(<span class="number">0</span>, d_model, <span class="number">2</span>) *</span><br><span class="line">                             -(math.log(<span class="number">10000.0</span>) / d_model))</span><br><span class="line">        pe[:, <span class="number">0</span>::<span class="number">2</span>] = torch.sin(position * div_term) <span class="comment"># 奇数</span></span><br><span class="line">        pe[:, <span class="number">1</span>::<span class="number">2</span>] = torch.cos(position * div_term) <span class="comment"># 偶数</span></span><br><span class="line">        pe = pe.unsqueeze(<span class="number">0</span>)</span><br><span class="line">        self.register_buffer(<span class="string">&#x27;pe&#x27;</span>, pe)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = x + Variable(self.pe[:, :x.size(<span class="number">1</span>)], requires_grad=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># self.pe[:, :x.size(1)]取到x的实际长度</span></span><br><span class="line">        <span class="keyword">return</span> self.dropout(x)</span><br></pre></td></tr></table></figure>
<p>可视化位置信息<br><img src="https://uploadfiles.nowcoder.com/images/20220620/799168342_1655740419415/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<h2 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h2><p>encoder由 N 层堆叠，将层复制 N 次。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clones</span>(<span class="params">module, N</span>):</span></span><br><span class="line">    <span class="keyword">return</span> nn.ModuleList([copy.deepcopy(module) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(N)])</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Encoder</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, layer, N</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Encoder, self).__init__()</span><br><span class="line">        self.layers = clones(layer, N)</span><br><span class="line">        self.norm = LayerNorm(layer.size)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, mask</span>):</span></span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers:</span><br><span class="line">            x = layer(x, mask) </span><br><span class="line">        <span class="keyword">return</span> self.norm(x)</span><br></pre></td></tr></table></figure>
<p>构造掩码，这里掩码的作用是屏蔽空白区域，decoder中掩码还有屏蔽未来信息的作用。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">subsequent_mask</span>(<span class="params">size</span>):</span></span><br><span class="line">    attn_shape = (<span class="number">1</span>, size, size)</span><br><span class="line">    subsequent_mask = np.triu(np.ones(attn_shape), k=<span class="number">1</span>).astype(<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> torch.from_numpy(subsequent_mask) == <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>encoder层包括多头注意力层和前馈全连接层这两个子层，每个子层后面都用归一和残差连接。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SublayerConnection</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, size, dropout</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SublayerConnection, self).__init__()</span><br><span class="line">        self.norm = LayerNorm(size)</span><br><span class="line">        self.dropout = nn.Dropout(dropout)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, sublayer</span>):</span></span><br><span class="line">        x_norm = self.norm(x + self.dropout(sublayer(x)))</span><br><span class="line">        <span class="comment"># 有的把x提出来加速收敛 x_norm = x + self.norm(self.dropout(sublayer(x))) </span></span><br><span class="line">        <span class="keyword">return</span> x_norm</span><br></pre></td></tr></table></figure>
<p>规范化层</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LayerNorm</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, feature_size, eps=<span class="number">1e-6</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(LayerNorm, self).__init__()</span><br><span class="line">        self.a_2 = nn.Parameter(torch.ones(feature_size))</span><br><span class="line">        self.b_2 = nn.Parameter(torch.zeros(feature_size))</span><br><span class="line">        self.eps = eps</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        mean = x.mean(-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">        std = x.std(-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> self.a_2 * (x - mean) / (std + self.eps) + self.b_2</span><br></pre></td></tr></table></figure>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EncoderLayer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, size, self_attn, feed_forward, dropout</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(EncoderLayer, self).__init__()</span><br><span class="line">        self.self_attn = self_attn</span><br><span class="line">        self.feed_forward = feed_forward</span><br><span class="line">        self.sublayer = clones(SublayerConnection(size, dropout), <span class="number">2</span>)</span><br><span class="line">        self.size = size</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, mask</span>):</span></span><br><span class="line">        <span class="comment"># 多注意力层</span></span><br><span class="line">        x = self.sublayer[<span class="number">0</span>](x, <span class="keyword">lambda</span> x: self.self_attn(x, x, x, mask))</span><br><span class="line">        <span class="comment"># 前馈传播层</span></span><br><span class="line">        z = self.sublayer[<span class="number">1</span>](x, self.feed_forward)</span><br><span class="line">        <span class="keyword">return</span> z</span><br></pre></td></tr></table></figure>
<p>attention层，采用多头注意力机制。</p>
<center> 
<img src="https://uploadfiles.nowcoder.com/images/20220620/799168342_1655728230104/D2B5CA33BD970F64A6301FA75AE2EB22" width="200">  
<img src="https://uploadfiles.nowcoder.com/images/20220620/799168342_1655728396309/D2B5CA33BD970F64A6301FA75AE2EB22" width="230">  
</center>
单头注意力中，QK矩阵内积求出相关性系数scores，判断是否使用掩码，对scores进行softmax，乘上V得到输出。

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attention</span>(<span class="params">query, key, value, mask=<span class="literal">None</span>, dropout=<span class="literal">None</span></span>):</span></span><br><span class="line">    d_k = query.size(-<span class="number">1</span>)</span><br><span class="line">    scores = torch.matmul(query, key.transpose(-<span class="number">2</span>, -<span class="number">1</span>)) / math.sqrt(d_k)</span><br><span class="line">    <span class="keyword">if</span> mask <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        scores = scores.masked_fill(mask == <span class="number">0</span>, -<span class="number">1e9</span>)</span><br><span class="line">    p_attn = F.softmax(scores, dim = -<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> dropout <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        p_attn = dropout(p_attn)</span><br><span class="line">    <span class="keyword">return</span> torch.matmul(p_attn, value), p_attn</span><br></pre></td></tr></table></figure>
<p>多头注意力，设计多种Q均衡偏差，让词义有多种表达。给每个头分配等量的词特征，四个线性层中有三个分别对应QKV，最后一个是对应拼接后的。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiHeadedAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, h, d_model, dropout=<span class="number">0.1</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(MultiHeadedAttention, self).__init__()</span><br><span class="line">        <span class="keyword">assert</span> d_model % h == <span class="number">0</span></span><br><span class="line">        self.d_k = d_model // h</span><br><span class="line">        self.h = h</span><br><span class="line">        self.linears = clones(nn.Linear(d_model, d_model), <span class="number">4</span>)</span><br><span class="line">        self.attn = <span class="literal">None</span></span><br><span class="line">        self.dropout = nn.Dropout(p=dropout)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, query, key, value, mask=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> mask <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            mask = mask.unsqueeze(<span class="number">1</span>)</span><br><span class="line">        nbatches = query.size(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        query, key, value = \</span><br><span class="line">            [l(x).view(nbatches, -<span class="number">1</span>, self.h, self.d_k).transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">             <span class="keyword">for</span> l, x <span class="keyword">in</span> <span class="built_in">zip</span>(self.linears, (query, key, value))]</span><br><span class="line">         </span><br><span class="line">        x, self.attn = attention(query, key, value, mask=mask, </span><br><span class="line">                                 dropout=self.dropout)</span><br><span class="line">  </span><br><span class="line">        x = x.transpose(<span class="number">1</span>, <span class="number">2</span>).contiguous() \</span><br><span class="line">             .view(nbatches, -<span class="number">1</span>, self.h * self.d_k)</span><br><span class="line">        <span class="keyword">return</span> self.linears[-<span class="number">1</span>](x)</span><br></pre></td></tr></table></figure>
<p>feed forward 层包括两个线性层和一个relu层。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PositionwiseFeedForward</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, d_model, d_ff, dropout=<span class="number">0.1</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(PositionwiseFeedForward, self).__init__()</span><br><span class="line">        self.w_1 = nn.Linear(d_model, d_ff)</span><br><span class="line">        self.w_2 = nn.Linear(d_ff, d_model)</span><br><span class="line">        self.dropout = nn.Dropout(dropout)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.w_2(self.dropout(F.relu(self.w_1(x))))</span><br></pre></td></tr></table></figure>
<h2 id="Decoder"><a href="#Decoder" class="headerlink" title="Decoder"></a>Decoder</h2><p>decoder 根据 encoder 的输出和上一次的预测结果，预测序列的下一个输出，由 N 个相同的层堆叠。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Decoder</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, layer, N</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Decoder, self).__init__()</span><br><span class="line">        self.layers = clones(layer, N)</span><br><span class="line">        self.norm = LayerNorm(layer.size)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, memory, src_mask, tgt_mask</span>):</span></span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers:</span><br><span class="line">            x = layer(x, memory, src_mask, tgt_mask)</span><br><span class="line">        <span class="keyword">return</span> self.norm(x)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecoderLayer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, size, self_attn, src_attn, feed_forward, dropout</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(DecoderLayer, self).__init__()</span><br><span class="line">        self.size = size</span><br><span class="line">        self.self_attn = self_attn</span><br><span class="line">        self.src_attn = src_attn</span><br><span class="line">        self.feed_forward = feed_forward</span><br><span class="line">        self.sublayer = clones(SublayerConnection(size, dropout), <span class="number">3</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, memory, src_mask, tgt_mask</span>):</span></span><br><span class="line">        m = memory</span><br><span class="line">        x = self.sublayer[<span class="number">0</span>](x, <span class="keyword">lambda</span> x: self.self_attn(x, x, x, tgt_mask))</span><br><span class="line">        x = self.sublayer[<span class="number">1</span>](x, <span class="keyword">lambda</span> x: self.src_attn(x, m, m, src_mask))</span><br><span class="line">        <span class="keyword">return</span> self.sublayer[<span class="number">2</span>](x, self.feed_forward)</span><br></pre></td></tr></table></figure>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Generator</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, d_model, vocab</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Generator, self).__init__()</span><br><span class="line">        self.proj = nn.Linear(d_model, vocab)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> F.log_softmax(self.proj(x), dim=-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EncoderDecoder</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, encoder, decoder, src_embed, tgt_embed, generator</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(EncoderDecoder, self).__init__()</span><br><span class="line">        self.encoder = encoder</span><br><span class="line">        self.decoder = decoder</span><br><span class="line">        self.src_embed = src_embed    </span><br><span class="line">        self.tgt_embed = tgt_embed    </span><br><span class="line">        self.generator = generator    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, src, tgt, src_mask, tgt_mask</span>):</span></span><br><span class="line">        memory = self.encode(src, src_mask)</span><br><span class="line">        res = self.decode(memory, src_mask, tgt, tgt_mask)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">self, src, src_mask</span>):</span></span><br><span class="line">        src_embedds = self.src_embed(src)</span><br><span class="line">        <span class="keyword">return</span> self.encoder(src_embedds, src_mask)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">self, memory, src_mask, tgt, tgt_mask</span>):</span></span><br><span class="line">        target_embedds = self.tgt_embed(tgt)</span><br><span class="line">        <span class="keyword">return</span> self.decoder(target_embedds, memory, src_mask, tgt_mask)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_model</span>(<span class="params">src_vocab, tgt_vocab, N=<span class="number">6</span>, d_model=<span class="number">512</span>, d_ff=<span class="number">2048</span>, h=<span class="number">8</span>, dropout=<span class="number">0.1</span></span>):</span></span><br><span class="line">    c = copy.deepcopy</span><br><span class="line">    attn = MultiHeadedAttention(h, d_model)</span><br><span class="line">    ff = PositionwiseFeedForward(d_model, d_ff, dropout)</span><br><span class="line">    position = PositionalEncoding(d_model, dropout)</span><br><span class="line">    model = EncoderDecoder(</span><br><span class="line">        Encoder(EncoderLayer(d_model, c(attn), c(ff), dropout), N),</span><br><span class="line">        Decoder(DecoderLayer(d_model, c(attn), c(attn), c(ff), dropout), N),</span><br><span class="line">        nn.Sequential(Embeddings(d_model, src_vocab), c(position)),</span><br><span class="line">        nn.Sequential(Embeddings(d_model, tgt_vocab), c(position)),</span><br><span class="line">        Generator(d_model, tgt_vocab))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> model.parameters():</span><br><span class="line">        <span class="keyword">if</span> p.dim() &gt; <span class="number">1</span>:</span><br><span class="line">            nn.init.xavier_uniform_(p)</span><br><span class="line">    <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-24T08:43:54.000Z" title="2022/3/24 下午4:43:54">2022-03-24</time>发表</span><span class="level-item"><time dateTime="2022-03-24T06:16:37.906Z" title="2022/3/24 下午2:16:37">2022-03-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%B7%B1%E5%BA%A6%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">深度强化学习</a></span><span class="level-item">几秒读完 (大约93个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/24/DRL%20-%2006/">DRL - 06Imitation Learning</a></h1><div class="content"><p><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648101762085/CF43271D0A0F19820126FF1E574E5CC4"></p>
<h1 id="behavior-cloning"><a href="#behavior-cloning" class="headerlink" title="behavior cloning"></a>behavior cloning</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648101765665/55D4AB2D545329E179A8522D795F9EC8"><br><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648101169717/3A2DD0BF7B13FAA88DCF6BA5EE158D06"><br><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648101820061/590DD10DCE22B30509B068B746748092"></p>
<h1 id="inverse-reinforcement-learning"><a href="#inverse-reinforcement-learning" class="headerlink" title="inverse reinforcement learning"></a>inverse reinforcement learning</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648101835469/DCBF327F2FBF3D5672779E11C55E0117"><br><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648101204419/DCC89819CB726FFDD01CEDB83D047DB7"><br><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648101213462/97C7A6FF6D365C860F5EDE0D61CD338F"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-23T08:43:54.000Z" title="2022/3/23 下午4:43:54">2022-03-23</time>发表</span><span class="level-item"><time dateTime="2022-03-24T06:16:31.787Z" title="2022/3/24 下午2:16:31">2022-03-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%B7%B1%E5%BA%A6%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">深度强化学习</a></span><span class="level-item">几秒读完 (大约66个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/23/DRL%20-%2005/">DRL - 05Sparse Reward</a></h1><div class="content"><p><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648102171639/5E14B20DFC4565D8F1562FD95983B188"></p>
<h1 id="reward-shaping"><a href="#reward-shaping" class="headerlink" title="reward shaping"></a>reward shaping</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648102180547/1120E1EB459E41134B6E779D59A5CB7B"><br><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648102189120/3A867A02FBF8AC8857BA6E7624A22184"></p>
<h1 id="curriculum-learning"><a href="#curriculum-learning" class="headerlink" title="curriculum learning"></a>curriculum learning</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648102201340/5767CBA8802A79A22853087D74B97FC0"></p>
<h1 id="hierarchical-RL"><a href="#hierarchical-RL" class="headerlink" title="hierarchical RL"></a>hierarchical RL</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648100913469/87BB4F6CD513449D152081BE83AB8740"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-22T08:43:54.000Z" title="2022/3/22 下午4:43:54">2022-03-22</time>发表</span><span class="level-item"><time dateTime="2022-03-24T06:13:57.446Z" title="2022/3/24 下午2:13:57">2022-03-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%B7%B1%E5%BA%A6%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">深度强化学习</a></span><span class="level-item">几秒读完 (大约89个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/22/DRL%20-%2004/">DRL - 04Actor-critic</a></h1><div class="content"><h1 id="AC-A2C-A3C"><a href="#AC-A2C-A3C" class="headerlink" title="AC A2C A3C"></a>AC A2C A3C</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042339634/4C4D66C754737FFA519F3047838A0DA0"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042355975/EBF03F57E426FAF695B90C41DE2BF613"><br><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648101448349/868EAE082864F29287E6358C3283F265"></p>
<h1 id="pathwise-derivative-policy-gradient"><a href="#pathwise-derivative-policy-gradient" class="headerlink" title="pathwise derivative policy gradient"></a>pathwise derivative policy gradient</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648101474752/BD049E7277CD3414C31B7AD57E32E6B6"><br><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648100746839/BC4D04DB860EAE4CC4CDA4D0342CC65E"><br><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648100867274/3FE01D8D05F5A0F080A27F7D66AC3A3A"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-21T06:43:54.000Z" title="2022/3/21 下午2:43:54">2022-03-21</time>发表</span><span class="level-item"><time dateTime="2022-03-24T00:35:02.244Z" title="2022/3/24 上午8:35:02">2022-03-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%B7%B1%E5%BA%A6%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">深度强化学习</a></span><span class="level-item">1 分钟读完 (大约208个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/21/DRL%20-%2003/">DRL - 03Q-learning</a></h1><div class="content"><p><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042040699/20BE83AB72BC7C946CB66EE7B50B1E24"></p>
<h1 id="introduction-of-Q-learning"><a href="#introduction-of-Q-learning" class="headerlink" title="introduction of Q-learning"></a>introduction of Q-learning</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042092223/D054BB4D5346A3CF45C831D4EC9D1368"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042104292/2418EC8BFEB99AA57C5E96C209412BF4"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042114457/0225F9498AD9FA0A36DEC771BB04C00E"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042128867/FEAD1795474B198582F1D4C35A36602B"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042139601/737F74D5B4A23526B26FB5EAE4A7393B"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042147896/5BDD82956C31D442C60389E4AFBED09B"></p>
<h1 id="Tips-of-Q-learning"><a href="#Tips-of-Q-learning" class="headerlink" title="Tips of Q-learning"></a>Tips of Q-learning</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042189969/3B64A4602539D2C3BFB84A94A1ED733F"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042197958/C9B30F93DB275862D7DA7BDD4DEE31E5"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042206708/EF4AE9B3B591DFAE0D06069F9C588D1E"><br><img src="https://uploadfiles.nowcoder.com/images/20220324/799168342_1648082056835/BDF857ADB7DD67134730B432F5CBFBEA"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042231153/5FE08FFC24BF8772E076570CE17F9BBB"></p>
<h1 id="Q-learning-for-Continuous-Actions"><a href="#Q-learning-for-Continuous-Actions" class="headerlink" title="Q-learning for Continuous Actions"></a>Q-learning for Continuous Actions</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042271663/B0315146CA68C1E729538D8EA22CB440"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042277973/C985C4D5F0A56AD3071FECCBDD6CFBAA"><br><img src="https://uploadfiles.nowcoder.com/images/20220323/799168342_1648042290311/10C8D2CDC2F051018309FD8FC1E467C2"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-20T06:43:54.000Z" title="2022/3/20 下午2:43:54">2022-03-20</time>发表</span><span class="level-item"><time dateTime="2022-03-22T09:18:38.766Z" title="2022/3/22 下午5:18:38">2022-03-22</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%B7%B1%E5%BA%A6%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">深度强化学习</a></span><span class="level-item">1 分钟读完 (大约125个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/20/DRL%20-%2002/">DRL - 02Proximal Policy Optimization (PPO)</a></h1><div class="content"><p><img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647940197319/C8C37FFF13CD1C4291DBE223E69EB63D"></p>
<h1 id="policy-gradient"><a href="#policy-gradient" class="headerlink" title="policy gradient"></a>policy gradient</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647940198384/38260D9FBFA655749A9324C1A6DED9C6"><br><img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647939692320/0B740460E645FA6BB7D197BAED267782"><br><img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647939692888/AE7B872520D7A1AFA2D1200CA032BA64"><br><img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647940309759/A6D9C38CE6BB4623D200F3E8DDF8828E"></p>
<h1 id="on-policy-and-off-policy"><a href="#on-policy-and-off-policy" class="headerlink" title="on-policy and off-policy"></a>on-policy and off-policy</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647940309573/D9603162E9E8161A290CEE3E8B44EC05"><br><img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647940494702/293C56598EA38F60D86E9C437AA81EF2"></p>
<h1 id="add-constraint"><a href="#add-constraint" class="headerlink" title="add  constraint"></a>add  constraint</h1><p><img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647940493995/9A69DB1BB784AB1BB81E377652785BD6"><br><img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647939692319/91B5B595EE4A3B189845CBEBE0D2AC95"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-19T06:43:54.000Z" title="2022/3/19 下午2:43:54">2022-03-19</time>发表</span><span class="level-item"><time dateTime="2022-03-24T00:26:57.520Z" title="2022/3/24 上午8:26:57">2022-03-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%B7%B1%E5%BA%A6%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">深度强化学习</a></span><span class="level-item">3 分钟读完 (大约443个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/19/DRL%20-%2001/">DRL - 01导论</a></h1><div class="content"><h1 id="ML-23-1-deep-reinforcement-learning"><a href="#ML-23-1-deep-reinforcement-learning" class="headerlink" title="ML 23-1 deep reinforcement learning"></a>ML 23-1 deep reinforcement learning</h1><h2 id="scenario-of-deep-reinforcement-learning"><a href="#scenario-of-deep-reinforcement-learning" class="headerlink" title="scenario of deep reinforcement learning"></a>scenario of deep reinforcement learning</h2><center>

<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647756724378/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" />
</center> 
  
<ul>
<li>learning to play GO</li>
</ul>
<center>
<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647768154424/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" /> 

</center> 

<ul>
<li>Supervised vs Reinforcement</li>
</ul>
<center>
<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647757249099/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" /> 
</center> 
  
<ul>
<li><p>applications</p>
<p>Gym: <a target="_blank" rel="noopener" href="https://gym.openai.com/">https://gym.openai.com/</a></p>
<p>Universe: <a target="_blank" rel="noopener" href="https://openai.com/blog/universe/">https://openai.com/blog/universe/</a></p>
</li>
<li><p>difficulties of reinforcement learning</p>
<p>reward delay 一些没有奖励的动作在当前看起来没有用，但对未来会产生影响，帮助在未来得到奖励。</p>
<p>agent’s actions affect the subsequent data it recevives，agent 需要去探索，不管是好的行为还是坏的。</p>
</li>
<li><p>outline</p>
</li>
</ul>
<center>
<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647755363206/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" /> 
</center> 


<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767017242/D2B5CA33BD970F64A6301FA75AE2EB22" width="500" height="400" align="bottom" /> 


<h2 id="Policy-based-Approach-Learning-an-Actor"><a href="#Policy-based-Approach-Learning-an-Actor" class="headerlink" title="Policy-based Approach - Learning an Actor"></a>Policy-based Approach - Learning an Actor</h2><ul>
<li>machine learning $\approx$ looking for a function</li>
</ul>
<center>
<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647762832664/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" />  
</center> 

<ul>
<li><p>找function 的三大步骤</p>
<center>
<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647762884480/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" />  
</center>   
</li>
<li><p>DRL</p>
<ol>
<li><p>neural network as actor</p>
<p> input: vector、matrix，eg: pixels</p>
<p> output: action 采取行动的几率，stochastic</p>
</li>
</ol>
  <center>
  <img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647763112995/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" /> 
  </center> 

<ol start="2">
<li><p>goodness of function </p>
<p>   supervised learning vs DRL</p>
</li>
</ol>
  <center>
  <img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647763524286/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" />  
</center>
<center>
  <img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647764231155/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" />  

  <img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647764706231/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" /> 
  </center> 

<ol start="3">
<li>pick the best</li>
</ol>
<ul>
<li>gradient ascent</li>
</ul>
<p><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767153569/D2B5CA33BD970F64A6301FA75AE2EB22"><br><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767164528/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<ul>
<li>add a baseline<center>
  <img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647765056343/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" /> 
  </center></li>
</ul>
</li>
</ul>
<h2 id="critics"><a href="#critics" class="headerlink" title="critics"></a>critics</h2><p>评估observation</p>
<center>
<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647765115892/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" /> 
</center> 


<h2 id="Actor-Critic"><a href="#Actor-Critic" class="headerlink" title="Actor-Critic"></a>Actor-Critic</h2><center>
<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647765184779/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" /> 
</center>   

<h1 id="ML-23-2-policy-gradient-Supplementary-Explanation"><a href="#ML-23-2-policy-gradient-Supplementary-Explanation" class="headerlink" title="ML 23-2 policy gradient (Supplementary Explanation)"></a>ML 23-2 policy gradient (Supplementary Explanation)</h1><center>
<img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767296123/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="300" align="bottom" /> 
</center>   



<h1 id="ML-23-3-RL"><a href="#ML-23-3-RL" class="headerlink" title="ML 23-3 RL"></a>ML 23-3 RL</h1><h2 id="interact-with-environments"><a href="#interact-with-environments" class="headerlink" title="interact with environments"></a>interact with environments</h2><p>  机器学到的行为会影响下一步的发展，所有的action 当成整体看待</p>
<h2 id="components"><a href="#components" class="headerlink" title="components"></a>components</h2><p>env、reward function不能控制，只能调整actor的行为</p>
<p><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767564318/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<h2 id="critic"><a href="#critic" class="headerlink" title="critic"></a>critic</h2><p><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767633152/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<p> 评估critic：</p>
<p> Monre-Carlo：</p>
<p> <img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767680293/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<p> Temporal defference：</p>
<p> <img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767696480/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<h2 id="Q"><a href="#Q" class="headerlink" title="Q"></a>Q</h2><p><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767742759/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<p>actor 如果⽆法穷举则会爆炸，采用PDPG</p>
<h2 id="pathwise-derivative-policy-gradient"><a href="#pathwise-derivative-policy-gradient" class="headerlink" title="pathwise derivative policy gradient"></a>pathwise derivative policy gradient</h2><p><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767821840/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<h2 id="Asynchronous-A3C"><a href="#Asynchronous-A3C" class="headerlink" title="Asynchronous A3C"></a>Asynchronous A3C</h2><p><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767964684/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<h2 id="imitation-learning"><a href="#imitation-learning" class="headerlink" title="imitation learning"></a>imitation learning</h2><p><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767837694/D2B5CA33BD970F64A6301FA75AE2EB22"><br><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767864450/D2B5CA33BD970F64A6301FA75AE2EB22"><br><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767875518/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<p>类似GAN:</p>
<p><img src="https://uploadfiles.nowcoder.com/images/20220320/799168342_1647767895614/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-15T06:43:54.000Z" title="2022/3/15 下午2:43:54">2022-03-15</time>发表</span><span class="level-item"><time dateTime="2022-08-08T05:44:18.135Z" title="2022/8/8 下午1:44:18">2022-08-08</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/">论文阅读</a></span><span class="level-item">24 分钟读完 (大约3535个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/15/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%20-%2002/">论文阅读 - Deep Reinforcement Learning for Programming Language Correction</a></h1><div class="content"><p>新手编程者经常饱受程序语言正规语法的折磨，为了协助他们，作者设计了一个基于强化学习的新型程序语言纠正框架，这个框架允许一个智能体 agent 模仿人类行为进行文本导航和编辑，展示了一个 agent 可以通过直接从原始的输入自我探索来进行训练，自我探索就是说，程序文本它自己，不利用程序语言正规语法的任何经验。我们充分利用专家案例作为 1&#x2F;10 的训练数据，来加速训练。</p>
<p>程序语言规定程序文本的语法规则检验。一个不遵守规则的程序文本不会被编译执行，这给新手编程者带来了障碍。在目前大量的线上编程课程中，从指导者获得个性化反馈是十分不可实行的。因此，作者的工作旨在利用技术帮助新手编程者，通过自动化修正程序中的通用语法错误。</p>
<p>作者通过强化学习提出这个问题。当面对一个错误，一个程序员根据程序文本找到错误的位置，然后修正编辑来修复错误。作者提出了一个新型程序语言修正框架，在这里，一个 agent 可以模仿这些行为。一个 agent 可以访问和修改一个程序文本，对它来说，检查程序文本语法有效性的编译器是一个黑盒子。编译器通常不会精确地指明错误的位置。所以，不能依赖编译器来找到错误的位置和进行修正。作者利用编译器生成的错误信息的数量设计了一个 reward function。agent 的目标是将程序成功编译所必要的编辑行为表现的最好。</p>
<p>框架的挑战是为程序文本的 agent 学习一个 control policy，不通过任何带有程序语言正规语法知识的 agent 。通过深度学习，agents 可以被训练到专家水平来玩视觉文字游戏，有趣的是，这些技术直接从原始输入，如像素、文本等。在这项工作中，第一次展示了它在程序空间中的可能性。</p>
<center>
  
<img src="https://uploadfiles.nowcoder.com/images/20220316/799168342_1647415782736/D2B5CA33BD970F64A6301FA75AE2EB22" width="500" height="600" align="bottom" />
  
</center>

  
<p>如图1，修复了税收算法，有两个语法错误：第四行的 scanf 使用错误， 第12行的 “}” 缺失。程序以被标记化的形式展现给 agent，agent 的指针位置被初始化为程序的第一个 token。在程序中 agent 的导向性的动作用箭头表示，系列动作如图所示。agent 准确定位和修复所有错误。首先，agent 导向错误的位置行4，用逗号替代不正确的分号，在错误2中插入丢失的 “}” 。这些编辑操作完成后，程序成功编译，agent 停止。这比蛮力列举编译修正高效很多。</p>
<p>通过长短期记忆网络 LSTM 网络进行编码，agent 被允许执行一系列的导航和编辑行为来修复程序。每一步修复错误的编辑都获得一些小的奖励，最大化达到目标状态的奖励，即程序的无错误状态。agent 的 control policy 就是学习使用 A3C 算法。</p>
<p>训练一个agent的难点有两个：（1）agent 要同时定位错误并在此做出精确的编辑来修复程序。错误的编辑会导致引入更多的错误，使得任务更加困难。为了克服这个问题，我们设定环境来拒绝这样的编辑。这显著的削减了 state space。（2）随着时间增长，任务的 state space 越来越大，state 探索收集的信息越来越多，的强化学习趋向越来越慢。一个方法是利用专家表示来引导 agent。在我们的工作中，这些表示是自动生成的而不是人类干预，我们将此称为 RLAssist。</p>
<p>DeepFix 是目前修复程序错误中表现最好的工具。作者在需要修复的 C 程序上对比该工具和 RLAssist 。作者证明了RLAssist可以通过只使用错误程序自我探索来训练，同时仍然可以达到 DeepFix 的性能。通过专家演示加速训练，为 10% 训练集生成专家演示，90% 的数据集没有演示。RLAssist完全修复了测试集中26.6%的程序，并解决了39.7%的错误消息。与DeepFix相比，这两个版本分别提高了14%和29%。因此，RLAssist在一小部分训练数据上使用专家演示，表现优于DeepFix。</p>
<p>此工作的主要贡献如下:</p>
<ol>
<li>设计了一种新颖的程序设计语言校正框架，可用于强化学习。</li>
<li>我们使用 A3C 来纠正编程语言，并通过专家演示加速培训。</li>
<li>我们的实验表明，我们的技术只使用了十分之一的训练数据，其性能超过了最先进的工具 DeepFix 。此外，我们的技术也可以在没有任何演示的情况下工作，但仍然可以匹配 DeepFix 的性能。</li>
<li>RLAssist 的实现将是开源的。</li>
</ol>
<h1 id="a-framework-for-programming-language-correction-tasks"><a href="#a-framework-for-programming-language-correction-tasks" class="headerlink" title="a framework for programming language correction tasks"></a>a framework for programming language correction tasks</h1><p>当面对一个错误时，一个程序员会定位程序中错误的位置并编辑操作来修复错误。出现大量错误时，程序员会重复如上步骤，此文提出程序语言修正框架，一个 agent 可以模仿以上的行为。</p>
<h2 id="states"><a href="#states" class="headerlink" title="states"></a>states</h2><p>一个 state 用一个 &lt; string , cursor &gt; 表示，string 表示程序文本，cursor $\in$ { 1,…,len(string) }，len(string) 表示 string 中 token 的数量。env 跟踪 string 中错误的数量。这些错误可以从 ground truth 确定(当 ground truth可获取时)，也可以从编辑器编译 string 时产生的错误消息来估计。对于编译器，我们使用 GNU C 编译器。</p>
<p>编码 state 到 a sequence of tokens。首先，将程序字符串转换成词汇序列，这些词汇是不同的类型，例如关键字、操作符、类型、函数、字面量和变量。此外，我们还保留换行符作为词汇，以允许在程序文本上进行二维导航操作。state 中 cursor 部分由一个特殊的 token 表示，插入到序列中，刚好在游标持有索引的 token 之后。</p>
<p>接下来，在所有程序中构建一个共享词汇表。除了一些常见的库函数(如 printf 和 scanf )外，所有其他函数和变量标识符都映射到一个特殊的 token ID。类似地，所有的字面值都根据其类型映射到特殊的 token ，例如，数字映射到 NUM ，字符串映射到 STR 。所有剩余的 tokens 都包含在词汇表中，无需任何修改。这种映射减少了 agent 看到的词汇表的大小。请注意，此编码仅在将 state 反馈给 agent 时才需要。基于这样的编码，agent 预测到的 actions，在原始程序 string 上被 env 执行。</p>
<h2 id="actions-and-transitions"><a href="#actions-and-transitions" class="headerlink" title="actions and transitions"></a>actions and transitions</h2><p>agent 的动作可以分为两类，一类是更新 cursor，一类是修改 string。我们将第一类称为导航操作，第二类为编辑操作。导航操作允许 agent 在 string 中导航。这些操作只改变一个 state 的游标，而不是 string 。另一方面，编辑操作用于纠错，只修改 string 而不修改游标。错误的编辑操作会在 string 中引入更多错误，而不是修复它们。我们将环境配置为拒绝所有此类编辑，以删除使修复程序变得更加困难的状态空间。此外，拒绝错误的编辑可以防止对程序的任意更改。</p>
<p>对于我们的任务，我们只允许两个导航操作，右移和下移。它们分别将光标设置为右侧的下一个 token 或下一行的第一个 token 。如果光标已经设置为一行的最后一个 token ，则右移动作没有效果；或者光标是最后一行的任何 token 时，向下移动没有效果。注意，向下移动操作是可能的，因为我们在状态编码中保留了换行符。</p>
<p>基于对程序员新手常见的排版错误的研究，我们设计了三种类型的编辑操作。第一个参数化插入 token 操作，插入参数 token 到光标位置之前。参数可以是一个修复的 token 集合中的任何 token ，称之为可变 tokens。第二个是删除操作，删除光标上的token，只有在来自可变 tokens 时才能删除。我们限制可变 tokens 为以下五个类型的 token：分号、括号、大括号、句号和逗号。第三个是是参数化的将 token1 替代为 token2 操作，将光标位置上的 token1 替换为 token2。在这个类中有四个操作：（1）“；”替换为“，”，（2）“，”替换为“；”，（3）“.”替换为“；”，（4）“；）”替换为“）；”。尽管可以用一系列的删除和插入操作替换原子替换操作，但使用它们可以防止组成的删除和&#x2F;或插入操作被环境拒绝的情况。</p>
<h2 id="episode，termination，and-rewards"><a href="#episode，termination，and-rewards" class="headerlink" title="episode，termination，and rewards"></a>episode，termination，and rewards</h2><ol>
<li><p>一个 episode 的</p>
<ul>
<li><p>开始</p>
<p>string：一个错误的程序文本</p>
<p>cursor：string 的第一个 token </p>
</li>
<li><p>结束</p>
<p>到达 goal state ：编辑后的程序被编译器成功编译</p>
</li>
</ul>
</li>
<li><p>termination 终止 </p>
<ul>
<li><p>在一个 episode 中，agent 被允许到达最大数目的 time steps，即 max_episode_len 时终止</p>
</li>
<li><p>在一个 episode 中，agent 只允许通过整个程序一次，即 agent 一旦经过程序的最后一个 token，这个 episode 就终止了</p>
</li>
</ul>
</li>
<li><p>reward 奖励</p>
<p>   在每一步，agent 会受到一个小的步长惩罚，一个较高的编辑惩罚</p>
<ul>
<li>step_penalty 步长惩罚：鼓励 agent 学会在最小步长中来修复程序</li>
<li>edit_penalty 编辑惩罚：编辑操作开销较大，需要调用编译器来验证，所以不鼓励 agent 做不必要的编辑</li>
<li>maximum_reward 最大奖励：agent 达到 goal state  </li>
<li>intermediate_reward 中间奖励：纠正至少一个错误的编辑操作</li>
</ul>
</li>
</ol>
<h1 id="model"><a href="#model" class="headerlink" title="model"></a>model</h1><p>首先，使用 LSTM 网络将 state 的 token 嵌入到实向量中， 最终的 state 是输出向量的各个元素均值。考虑到 state 的嵌入，作者采用两个独立的全连接线性层，来生成策略函数 $\pi$(a|s; $\theta$) 和值函数 V(s;w) 。更新网络参数前，计算累积梯度：</p>
<center>
    
<!-- $d \theta \leftarrow d \theta + {\Delta }_{\theta '} log \pi (a_t | s_t ; \theta ')(R - V(s_t ;w'))$
  
$dw \leftarrow dw + {\Delta }_{w'}(R-V(s_t;w'))^2 $

$R= \sum _{i=0}^{k-1} \gamma ^i r_{t+i}+ \gamma ^k V(s_{t+k};w')$ -->
 <img src="https://uploadfiles.nowcoder.com/images/20220322/799168342_1647947823063/D2B5CA33BD970F64A6301FA75AE2EB22" width="400" height="120" align="bottom" />
</center>

<p>$H$ 是熵，$\beta$ 是它的正则化项超参数。</p>
<h2 id="expert-demonstrations"><a href="#expert-demonstrations" class="headerlink" title="expert demonstrations"></a>expert demonstrations</h2><p>RLAssist可以不使用任何演示进行训练，但会耗费更长的训练时间。原因是在A3C算法，每一个 episode 中，一个 agent 从一个随机 state 开始，然后使用它的 policy function 与环境进行交互。由于 policy network 是随机初始化的，因此在训练开始时，这种交互随机进行探索。在只进行随机探索的情况下，agent 会发现很难到达目标状态，也很难获得奖励。因此，训练速度减慢。</p>
<p>作者使用专家演示来加速训练。专家演示是指向事件目标状态的一系列动作。给定一对 (p, p’) ，其中 p 是一个不正确的程序， p’ 是它的正确版本，将自动生成如下的演示。从 p’ 中的第一个 token 开始，每个未修改的行 (w.r.t. p) 都会通过一个向下移动操作跳过。在第一个错误行，光标通过向右移动操作向右移动，直到到达错误位置并生成适当的编辑操作。这个过程一直重复，直到程序中的最后一个错误被解决。我们将 agent 设定为使用以下专家演示。对于可以进行演示的 episodes ，agent 遵循所提供的预定动作序列，而不是由 policy 驱动的 sampling 。对 policy network 参数的更新就像预先确定的动作 sampled 一样。对于其他 episode ，代理将按照标准的 A3C 算法，使用 policy 来 sample 的动作。请注意，演示是在 episode 级别提供的，而不是在更细粒度的转换级别上提供的。因为 agent 需要在整个事件中采取正确的行动来达到目标状态并获得奖励。如果它采取断断续续的指导，那么它仍然无法达到目标状态。</p>
<h1 id="experiments"><a href="#experiments" class="headerlink" title="experiments"></a>experiments</h1><p><a target="_blank" rel="noopener" href="https://bitbucket.org/iiscseal/rlassist/src/master/">https://bitbucket.org/iiscseal/rlassist/src/master/</a></p>
<center> 
  
<p><img src="https://uploadfiles.nowcoder.com/images/20220321/799168342_1647834031836/D2B5CA33BD970F64A6301FA75AE2EB22"><br><img src="https://uploadfiles.nowcoder.com/images/20220321/799168342_1647834043047/D2B5CA33BD970F64A6301FA75AE2EB22"><br><img src="https://uploadfiles.nowcoder.com/images/20220321/799168342_1647834055662/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
</center> 

  
  

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-14T06:43:54.000Z" title="2022/3/14 下午2:43:54">2022-03-14</time>发表</span><span class="level-item"><time dateTime="2022-08-08T05:44:14.489Z" title="2022/8/8 下午1:44:14">2022-08-08</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/">论文阅读</a></span><span class="level-item">12 分钟读完 (大约1837个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/14/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%20-%2001/">论文阅读 - DeepFix Fixing Common C Language Errors by Deep Learning</a></h1><div class="content"><p><font color=red>program repair ≈ grammar correction in nlp </font> 作者提出了一个端到端的，带 attention 的多层 seq2seq neural network，包括 RNN 编码器，和带 attention 的 RNN 解码器。该网络可以预测程序出错的位置并附上正确的修复。对比其他修复特定编程任务的工作，DeepFix 可以用在任何未预见的任务上。不易解决的错误需要考虑到程序文本中的长期依赖。DeepFix 通过带注意力机制的 seq2seq 模型来捕捉长期依赖。它的优势在于：(1) 利用端对端的基于深度学习网络解决普遍的编程问题；(2) 可以迭代地解决一个程序中的多个错误；(3) 在上千 C 程序评估中得到很好的结果。</p>
<center> 
  
<p><img src="https://uploadfiles.nowcoder.com/images/20220316/799168342_1647418479824/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
</center> 

<h2 id="Program-Representation"><a href="#Program-Representation" class="headerlink" title="Program Representation"></a>Program Representation</h2><p>程序文本由不同类型的标记组成，如类型、关键字、特殊字符(如分号)、函数、文字和变量。其中，类型、关键字、特殊字符和库函数构成了跨不同程序的共享词汇表。作者在表示程序时保留它们，对其他类型的 token 进行如下建模。首先定义一个固定大小的名称池，然后为每个程序构造一个单独的编码映射 encoding map ，方法是将程序中每个不同的标识符(变量名或函数名)随机映射到池中唯一的名称，并选择一个足够大的池来为数据集中的任何程序创建上述映射。这种转换不会改变程序的语义，且是可逆的。字面量的确切值对学习任务无关紧要，因此，根据字面值的类型将其映射为特殊的 token ，例如，将所有整数字面值映射为 NUM ，将所有字符串字面值映射为 STR 。用 &lt; eos &gt; 表示标记序列的结束。</p>
<p>由于一个程序用 seq 的 tokens 表示时，要产生类似长度的准确修复后的 seq 非常困难，且一个程序通常包含上百个 token。所以作者把代码行号也进行标记，将一个 K 行的程序 P 表示为 $(l_1 , s_1 ),…,( l_k ,s_k)&lt; eos &gt;$，l 和 s 分别是对行号和语句的标记。一个 fix 包括 $l_i , s_i$ ，这比用全部的 token 作为输出简单得多。</p>
<h2 id="Neural-Network-Architecture"><a href="#Neural-Network-Architecture" class="headerlink" title="Neural Network Architecture"></a>Neural Network Architecture</h2><p>基于 Neural Machine Translation by Jointly Learning to Align and Translate ，NLP 中 encoder-decoder 中第一个使用 attention 机制的工作，将 attention 机制用到了神经网络机器翻译(NMT)。<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1409.0473.pdf">https://arxiv.org/pdf/1409.0473.pdf</a> </p>
<center> 
<img src="https://uploadfiles.nowcoder.com/images/20220317/799168342_1647524223832/D2B5CA33BD970F64A6301FA75AE2EB22" height=300, weight=30>  
</center>
  
<p> 这里编码器和解码器 rnn 都由 N 个堆叠的门控循环单元(GRUs)组成。编码器将输入序列中的每个 token 映射到一个称为 annotation 的实向量。对于输入序列$x_1，…，x_{T_x}$, t 时刻的隐藏单元激活计算如下:<br>  <center> </p>
<p>  $h_t^{(1)} &#x3D; GRU(h_{t-1}^{(1)},x_t)$</p>
<p>  $h_t^{(n)} &#x3D; GRU(h_{t-1}^{(n)},h_t^{(n-1)}),\forall n \in { 2,…,N }$</p>
  </center> 

<p>解码器网络的隐藏状态被初始化为用编码器网络的最终状态，然后更新：</p>
  <center> 
    
<p>  $d_t^{(n)} &#x3D; GRU(d_{t-1}^{(n)},d_t^{(n-1)}),\forall n \in { 2,…,N }$</p>
<p>  $d_t^{(1)} &#x3D; GRU(d_{t-1}^{(1)},z_t)$</p>
  </center> 
  
<p>  其中 $z_t$ 是输出 $\hat{y}_{t-1}$在 $t-1$ 和上下文向量 $c_t$ 的连接，定义如下:</p>
  <center> 
    
<p>  $c_t &#x3D; \sum_{j&#x3D;1}^{T_x} a_{tj}h_j^{(N)}$</p>
<p>  $a_{tj} &#x3D; \frac{exp(e_{tj})}{\sum_{k&#x3D;1}^{T_x}exp(e_{tk})}$</p>
<p>  $e_{tk} &#x3D; \Phi(d_{t-1},h_k^{(N)})$  </p>
  </center> 
  
<p>  c 就是全部隐状态的一个加权和，用到归一化权重 a 。a 就是一个对齐模型，用来评估当前预测词，与输入词每一个词的相关度。将上一个输出序列隐状态 $d_{t-1}$ 和输入序列隐状态 $h$ 输入网络，然后做 softmax 归一化，计算出权重。</p>
<h2 id="Iterative-Repair"><a href="#Iterative-Repair" class="headerlink" title="Iterative Repair"></a>Iterative Repair</h2><p>  DeepFix 使用简单而有效的迭代策略来修复程序中的多个错误。oracle 的工作是通过检查更新后的程序是否比输入的程序好来决定是否接受修复。如果更新后的程序不会比输入程序产生更多的错误消息，则使用编译器并接受修复。我们还使用一些启发式方法来防止对输入程序的任意更改。例如，如果 oracle 不保留原始语句 $s_i$ 中的标识符和关键字，则它拒绝 fix $s_i$。一旦修复程序被接受，DeepFix 将再次向网络显示更新后的程序。</p>
<center>   
  
<p><img src="https://uploadfiles.nowcoder.com/images/20220316/799168342_1647418498443/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
</center>   
  
<p>  这种迭代策略停止的条件：(1) oracle 确定更新程序没有任何错误；或 (2) 网络视输入程序是正确的，发出一种特殊 token “fix”；或 (3) oracle拒绝修复,或 (4)达到预定的迭代的数量上限。</p>
<p>  除了决定是否替换语句，网络还会决定新的一行是否要插入在行前或行后，用 $l_i^-,l_i^+$ 代替 $l_i$，如果要删除行，则将 $l_i$ 带上空字符 $\epsilon$。oracle 使用程序特殊的编码映射，将修复好的 token sequence 重构回原来的标识符。它使用修复中的行号，并用输入程序中相应行中的字面值替换诸如 NUM 和 STR 等特殊标记。如果 oracle 不能重建程序文本，那么它拒绝修复。</p>
<p>作者提出的修复策略有几个优点：(1) 程序完整地呈现在网络上。识别和修复编程错误通常需要能够推断长期依赖关系的全局分析。网络架构能够有选择地参与程序的任何部分，可以推理结构和语法约束，以预测错误的位置和需要的修复。(2) 在输入和输出中都包含行号，降低了粒度，从而降低了预测任务的复杂性。(3) DeepFix可以迭代地修复程序中的多个错误。(4) oracle用于跟踪进度，防止无用的或任意的更改。(5) DeepFix的修复策略比较泛化。例如，如果我们试图修复逻辑错误，我们可以使用测试引擎和测试套件作为oracle。如果修复程序通过了更多的测试，那么它将被接受。</p>
<h2 id="Experiments"><a href="#Experiments" class="headerlink" title="Experiments"></a>Experiments</h2><p><a target="_blank" rel="noopener" href="https://bitbucket.org/iiscseal/deepfix">https://bitbucket.org/iiscseal/deepfix</a></p>
<p>数据集：两类程序，一种是编译的程序(正确的程序)，另一种是不编译的程序(错误的程序)。一个学生可能会提交几个错误的程序，作者在每个学生的每个编程任务中随机选择一个错误的程序，以避免测试结果的偏差。采用五折交叉验证</p>
<center>    

<p><img src="https://uploadfiles.nowcoder.com/images/20220318/799168342_1647565689717/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
<p><img src="https://uploadfiles.nowcoder.com/images/20220317/799168342_1647529035097/D2B5CA33BD970F64A6301FA75AE2EB22"><br><img src="https://uploadfiles.nowcoder.com/images/20220317/799168342_1647529133019/D2B5CA33BD970F64A6301FA75AE2EB22"><br><img src="https://uploadfiles.nowcoder.com/images/20220317/799168342_1647529139461/D2B5CA33BD970F64A6301FA75AE2EB22"></p>
</center>  </div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">上一页</a></div><div class="pagination-next"><a href="/page/3/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="🐏"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">🐏</p><p class="is-size-6 is-block">DubistmeinAugenstern</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>WuHan,China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">33</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">8</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Yang-Emily" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Yang-Emily"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Instagram" href="https://www.instagram.com/wuyangemily/"><i class="fab fa-instagram"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Youtube" href="https://www.youtube.com/channel/UCSnojGpH9om-xzl-og2_AZQ/featured"><i class="fab fa-youtube"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="twitter" href="https://twitter.com/wuyangemily"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="QQ" href="http://wpa.qq.com/msgrd?v=3&amp;uin=1047772929&amp;site=qq&amp;menu=yes"><i class="fab fa-qq"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://leetcode-cn.com/u/wuyangemily/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Leetcode</span></span><span class="level-right"><span class="level-item tag">leetcode-cn.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/qq_44729001" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://www.kaggle.com/wuyangemily" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Kaggle</span></span><span class="level-right"><span class="level-item tag">www.kaggle.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Pytorch/"><span class="level-start"><span class="level-item">Pytorch</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E5%AD%A6/"><span class="level-start"><span class="level-item">数学</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">机器学习</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%9D%82/"><span class="level-start"><span class="level-item">杂</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">深度学习</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%B7%B1%E5%BA%A6%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">深度强化学习</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86/"><span class="level-start"><span class="level-item">自然语言处理</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/"><span class="level-start"><span class="level-item">论文阅读</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-23T06:43:54.000Z">2022-10-23</time></p><p class="title"><a href="/2022/10/23/pytorch-%E7%94%9F%E6%80%81%E9%83%A8%E7%BD%B2/">pytorch - 生态和部署</a></p><p class="categories"><a href="/categories/Pytorch/">Pytorch</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-22T06:43:54.000Z">2022-10-22</time></p><p class="title"><a href="/2022/10/22/pytorch-%E5%8F%AF%E8%A7%86%E5%8C%96/">pytorch - 可视化</a></p><p class="categories"><a href="/categories/Pytorch/">Pytorch</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-20T06:43:54.000Z">2022-10-20</time></p><p class="title"><a href="/2022/10/20/pytorch-%E8%AE%AD%E7%BB%83%E6%8A%80%E5%B7%A7/">pytorch - 训练技巧</a></p><p class="categories"><a href="/categories/Pytorch/">Pytorch</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-16T06:43:54.000Z">2022-10-16</time></p><p class="title"><a href="/2022/10/16/pytorch-%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89/">pytorch - 模型定义</a></p><p class="categories"><a href="/categories/Pytorch/">Pytorch</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-12T06:43:54.000Z">2022-10-12</time></p><p class="title"><a href="/2022/10/12/pytorch-%E5%90%84%E4%B8%AA%E7%BB%84%E4%BB%B6%E5%92%8C%E5%AE%9E%E8%B7%B5/">pytorch - 各个组件和实践</a></p><p class="categories"><a href="/categories/Pytorch/">Pytorch</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/DL/"><span class="tag">DL</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DRL/"><span class="tag">DRL</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Draft/"><span class="tag">Draft</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Intelligence-Code/"><span class="tag">Intelligence Code</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linear-Algebra/"><span class="tag">Linear Algebra</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ML/"><span class="tag">ML</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NLP/"><span class="tag">NLP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pytorch/"><span class="tag">Pytorch</span><span class="tag">6</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="🐏&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Yang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Yang-Emily/Yang-Emily.github.io"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mhchem.min.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>